<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Cycle | æ™ºèƒ½æé†’ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ä¿æŒåŸæœ‰çš„ CSS ä¸å˜ï¼Œä¸ºäº†ç¯‡å¹…æˆ‘åªåˆ—å‡ºæ–°å¢çš„ */
        :root { --primary: #2563eb; --danger: #ef4444; --warning: #f59e0b; --bg: #f8fafc; --card-bg: #ffffff; --text: #1e293b; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 600px; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .hidden { display: none !important; }

        /* ç™»å½•é¡µ */
        .auth-box { text-align: center; max-width: 400px; margin: 60px auto; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 1rem; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-top: 10px; }

        /* é¡¶éƒ¨ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .user-controls { display: flex; gap: 15px; align-items: center; font-size: 0.9rem; }
        .link-btn { color: #64748b; cursor: pointer; text-decoration: none; border: none; background: none; font-size: 0.9rem; }
        .link-btn:hover { color: var(--primary); }

        /* åˆ—è¡¨é¡¹ */
        .item-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 15px; position: relative; }
        .item-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .item-name { font-weight: 600; font-size: 1.15rem; flex-grow: 1; }
        .del-btn-icon { color: #cbd5e1; cursor: pointer; font-size: 1.2rem; padding: 4px; margin-top: -4px; border-radius: 4px; }
        .del-btn-icon:hover { color: var(--danger); background-color: #fee2e2; }
        .item-meta { display: flex; justify-content: space-between; font-size: 0.9rem; color: #64748b; margin-bottom: 12px; }
        .progress-track { height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 320px; text-align: center; }
    </style>
</head>
<body>

    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">ç¡®è®¤åˆ é™¤?</div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-outline" onclick="closeConfirm()" style="margin-top:0">å–æ¶ˆ</button>
                <button id="confirm-del-btn" class="btn btn-primary" style="background:var(--danger); border:none;">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">ğŸ“« æ¥æ”¶æé†’</div>
            <p style="color:#64748b; font-size:0.9rem; margin-bottom:20px;">ç»‘å®šçœŸå®é‚®ç®±åï¼Œç‰©å“è¿‡æœŸå‰ä¼šæ”¶åˆ°é‚®ä»¶é€šçŸ¥ã€‚</p>
            <input type="email" id="notify-email-input" placeholder="è¾“å…¥ä½ çš„çœŸå®é‚®ç®±">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="closeEmailModal()" style="margin-top:0">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="app.saveEmail()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="auth-view" class="auth-box card hidden">
            <h2 style="margin-top:0;">Cycle</h2>
            <input type="text" id="username" placeholder="ç”¨æˆ·å" autocomplete="off">
            <input type="password" id="password" placeholder="å¯†ç ">
            <button class="btn btn-primary" onclick="auth.login()">ç™» å½•</button>
            <button class="btn btn-outline" onclick="auth.signup()">æ³¨ å†Œ</button>
            <div id="auth-msg" style="color:var(--danger); font-size:0.9rem; margin-top:15px;"></div>
        </div>

        <div id="app-view" class="hidden">
            <header>
                <h1>Cycle</h1>
                <div class="user-controls">
                    <span id="display-name" style="font-weight:bold"></span>
                    <button onclick="showEmailModal()" class="link-btn">ğŸ”” æé†’</button>
                    <button onclick="auth.logout()" class="link-btn" style="color:var(--danger)">é€€å‡º</button>
                </div>
            </header>

            <div class="card">
                <h3 style="margin-top:0; margin-bottom:15px; font-size:1.1rem;">ğŸ“ æ–°å¢è®°å½•</h3>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <input type="text" id="itemName" placeholder="ç‰©å“åç§°" style="flex:2; min-width: 180px;">
                    <input type="date" id="startDate" style="flex:1; min-width: 130px;">
                </div>
                <div style="display:flex; gap:12px;">
                    <input type="number" id="duration" placeholder="æœ‰æ•ˆæœŸ" style="flex:1">
                    <select id="unit" style="flex:1">
                        <option value="months" selected>ä¸ªæœˆ</option>
                        <option value="days">å¤©</option>
                        <option value="years">å¹´</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="app.add()" style="margin-top:5px;">å¼€å§‹è¿½è¸ª</button>
            </div>

            <div id="item-list"></div>
        </div>
    </div>

    <script>
        // é…ç½®åŒº
        const SUPABASE_URL = 'ä½ çš„_PROJECT_URL'; // è®°å¾—å¡«å›ä½ çš„
        const SUPABASE_KEY = 'ä½ çš„_ANON_KEY';    // è®°å¾—å¡«å›ä½ çš„
        const FAKE_SUFFIX = '@cycle.com';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;
        document.getElementById('startDate').valueAsDate = new Date();

        // --- å¼¹çª—é€»è¾‘ ---
        let deleteTargetId = null;
        function showConfirm(id) { deleteTargetId = id; document.getElementById('confirm-modal').classList.remove('hidden'); }
        function closeConfirm() { deleteTargetId = null; document.getElementById('confirm-modal').classList.add('hidden'); }
        document.getElementById('confirm-del-btn').addEventListener('click', () => { if(deleteTargetId) app.del(deleteTargetId); closeConfirm(); });

        // é‚®ç®±è®¾ç½®å¼¹çª—
        function showEmailModal() { 
            document.getElementById('notify-email-input').value = currentUser.user_metadata.notify_email || '';
            document.getElementById('email-modal').classList.remove('hidden'); 
        }
        function closeEmailModal() { document.getElementById('email-modal').classList.add('hidden'); }

        const auth = {
            getFakeEmail(username) { return username.trim() + FAKE_SUFFIX; },
            async signup() {
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                if (!u || !p) return;
                const { error } = await supabase.auth.signUp({
                    email: this.getFakeEmail(u), password: p,
                    options: { data: { just_name: u } } // æ³¨å†Œæ—¶ä¸å¸¦ notify_email
                });
                if (error) document.getElementById('auth-msg').textContent = error.message;
                else document.getElementById('auth-msg').textContent = 'æ³¨å†ŒæˆåŠŸï¼Œç™»å½•ä¸­...';
            },
            async login() {
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                const { error } = await supabase.auth.signInWithPassword({ email: this.getFakeEmail(u), password: p });
                if (error) document.getElementById('auth-msg').textContent = 'è´¦å·æˆ–å¯†ç é”™è¯¯';
            },
            async logout() { await supabase.auth.signOut(); }
        };

        const app = {
            data: [],
            async load() {
                const { data } = await supabase.from('cycle_items').select('*').order('created_at', { ascending: false });
                if (data) { this.data = data; this.render(); }
            },
            async add() {
                const name = document.getElementById('itemName').value;
                const date = document.getElementById('startDate').value;
                const dur = document.getElementById('duration').value;
                const unit = document.getElementById('unit').value;
                if (!name || !date || !dur) return alert('è¯·å¡«å…¨ä¿¡æ¯');
                const { data, error } = await supabase.from('cycle_items').insert([{
                    name, start_date: new Date(date).toISOString(), duration: dur, unit, user_id: currentUser.id
                }]).select();
                if (!error) { this.data.unshift(data[0]); this.render(); }
            },
            async del(id) {
                const { error } = await supabase.from('cycle_items').delete().eq('id', id);
                if (!error) { this.data = this.data.filter(i => i.id !== id); this.render(); }
            },
            // [æ–°å¢] ä¿å­˜çœŸå®é‚®ç®±åˆ° user_metadata
            async saveEmail() {
                const email = document.getElementById('notify-email-input').value;
                if (!email.includes('@')) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±');
                
                const { data, error } = await supabase.auth.updateUser({
                    data: { notify_email: email }
                });

                if (error) alert('ä¿å­˜å¤±è´¥: ' + error.message);
                else {
                    alert('è®¾ç½®æˆåŠŸï¼å½“ç‰©å“å¿«è¿‡æœŸæ—¶ï¼Œä¼šå‘é€é‚®ä»¶åˆ°: ' + email);
                    currentUser = data.user; // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
                    closeEmailModal();
                }
            },
            render() {
                const list = document.getElementById('item-list');
                list.innerHTML = '';
                this.data.forEach(item => list.innerHTML += this.html(item));
            },
            html(item) {
                const start = new Date(item.start_date); const end = new Date(start);
                if (item.unit === 'days') end.setDate(start.getDate() + parseInt(item.duration));
                if (item.unit === 'months') end.setMonth(start.getMonth() + parseInt(item.duration));
                if (item.unit === 'years') end.setFullYear(start.getFullYear() + parseInt(item.duration));
                const now = new Date();
                const daysLeft = Math.ceil((end - now) / 86400000);
                let per = ((now - start) / (end - start)) * 100;
                if (per > 100) per = 100; if (per < 0) per = 0;
                let color = daysLeft < 0 ? 'var(--danger)' : (daysLeft < 7 ? 'var(--warning)' : 'var(--primary)');
                const unitMap = { days:'å¤©', months:'ä¸ªæœˆ', years:'å¹´' };
                return `<div class="item-card">
                    <div class="item-top">
                        <div class="item-name">${item.name}</div>
                        <div class="del-btn-icon" onclick="showConfirm(${item.id})">ğŸ—‘ï¸</div>
                    </div>
                    <div class="item-meta">
                        <div>${start.toLocaleDateString()} Â· ${item.duration}${unitMap[item.unit]}</div>
                        <div style="color:${color};font-weight:bold">${daysLeft<0?'è¿‡æœŸ '+Math.abs(daysLeft):'å‰© '+daysLeft} å¤©</div>
                    </div>
                    <div class="progress-track"><div class="progress-fill" style="width:${per}%;background:${color}"></div></div>
                </div>`;
            }
        };

        supabase.auth.onAuthStateChange((e, session) => {
            if (session) {
                currentUser = session.user;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('display-name').textContent = currentUser.user_metadata.just_name || 'ç”¨æˆ·';
                app.load();
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });
    </script>
</body>
</html>