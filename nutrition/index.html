<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI é¥®é£Ÿç®¡å®¶</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://lib.baomitu.com/exif-js/2.3.0/exif.min.js"></script>
    <link rel="stylesheet" href="https://lib.baomitu.com/flatpickr/4.6.13/flatpickr.min.css">
    <script src="https://lib.baomitu.com/flatpickr/4.6.13/flatpickr.min.js"></script>
    
    <script>
        (function (global, factory) {
            typeof exports === 'object' && typeof module !== 'undefined' ? factory(global.flatpickr) :
            typeof define === 'function' && define.amd ? define(['flatpickr'], factory) :
            (factory(global.flatpickr));
        }(this, (function (flatpickr) { 'use strict';
            var fp = flatpickr.l10ns;
            var zh = {
                weekdays: { shorthand: ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"], longhand: ["æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"] },
                months: { shorthand: ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"], longhand: ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"] },
                rangeSeparator: " è‡³ ", weekAbbreviation: "å‘¨", scrollTitle: "æ»šåŠ¨åˆ‡æ¢", toggleTitle: "ç‚¹å‡»åˆ‡æ¢ 12/24 å°æ—¶æ—¶åˆ¶"
            };
            fp.zh = zh; fp.default.l10n = zh;
        })));
    </script>

    <style>
        :root { --primary: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF; --text-main: #000000; --text-sub: #8E8E93; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif; background: var(--bg); margin: 0; padding-bottom: 140px; color: var(--text-main); }
        .header { position: sticky; top: 0; background: rgba(242, 242, 247, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 12px 20px; z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 6px; cursor: pointer; background: rgba(0,0,0,0.05); padding: 8px 16px; border-radius: 20px; transition: 0.2s; }
        .header-title:active { opacity: 0.6; }
        .stat-capsule { display: flex; flex-direction: column; align-items: flex-end; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--primary); font-family: "SF Pro Rounded", system-ui; }
        .stat-label { font-size: 10px; color: var(--text-sub); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .container { padding: 16px; max-width: 600px; margin: 0 auto; }
        .meal-card { background: var(--card-bg); border-radius: 24px; margin-bottom: 24px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s; }
        .meal-card:active { transform: scale(0.98); }
        .meal-img-box { width: 100%; background: #f0f0f0; position: relative; display: flex; }
        .meal-img { width: 100%; height: auto; display: block; }
        .img-time-badge { position: absolute; top: 16px; left: 16px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); color: white; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; }
        .meal-content { padding: 16px 20px; }
        .meal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .meal-name { font-size: 20px; font-weight: 700; line-height: 1.3; color: #1d1d1f; }
        .meal-cal-badge { background: rgba(0,122,255,0.1); color: var(--primary); font-weight: 700; font-size: 15px; padding: 4px 10px; border-radius: 8px; white-space: nowrap; margin-left: 10px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px 8px; background: #F9F9F9; padding: 16px 12px; border-radius: 14px; }
        .metric-item { display: flex; flex-direction: column; align-items: center; }
        .m-val { font-size: 14px; font-weight: 700; color: #333; }
        .m-label { font-size: 10px; color: #999; margin-top: 2px; }
        .flatpickr-day.has-record::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background-color: var(--primary); border-radius: 50%; }
        .fab-bar { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; gap: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 8px 10px; border-radius: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); border: 1px solid rgba(0,0,0,0.05); }
        .fab-btn { width: 56px; height: 56px; border-radius: 28px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: 0.2s; }
        .fab-primary { background: #000; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .fab-secondary { background: transparent; color: #333; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-sub); }
        .loading-spinner { width: 24px; height: 24px; border: 3px solid #ddd; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #upload-mask { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-title" id="datePickerBtn">
            <span id="headerDateStr">ä»Šå¤©</span>
            <small>â–¼</small>
        </div>
        <div class="stat-capsule">
            <div class="stat-val" id="dayTotal">0</div>
            <div class="stat-label">KCAL</div>
        </div>
    </div>

    <div class="container" id="listContainer">
        <div class="empty-state"><div class="loading-spinner"></div></div>
    </div>

    <div class="fab-bar">
        <button class="fab-btn fab-secondary" onclick="safeTrigger('album')">ğŸ–¼ï¸</button>
        <button class="fab-btn fab-primary" onclick="safeTrigger('camera')">ğŸ“¸</button>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display:none">

    <div id="upload-mask">
        <div class="loading-spinner" style="width:40px;height:40px;border-width:4px;"></div>
        <h3 style="margin:20px 0 5px;">AI åˆ†æä¸­</h3>
        <p style="color:#888;font-size:14px;">å‡†å¤‡é«˜æ¸…ç´ æ Â· è¯†åˆ«é£Ÿæ</p>
    </div>

    <script>
        const CONFIG = {
            url: 'https://kliydumuddzylhmnnmyt.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsaXlkdW11ZGR6eWxobW5ubXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTE5MzAsImV4cCI6MjA4MzE2NzkzMH0.jpO3hYrQ-UCfo3AiZKt3b8F9EBpWrybvbqjY9P-6FV4',
            funcUrl: 'https://kliydumuddzylhmnnmyt.supabase.co/functions/v1/nutrition'
        };

        let db = null;
        let currentDate = new Date();
        let calendarInstance = null;
        let recordedDates = new Set();

        window.onload = async function() {
            if (window.supabase && window.supabase.createClient) {
                db = window.supabase.createClient(CONFIG.url, CONFIG.key);
                initCalendar();
                loadData(currentDate);
                await fetchRecordedDates();
                if (calendarInstance) calendarInstance.redraw();
            } else {
                alert("ç»„ä»¶åŠ è½½å¤±è´¥");
            }
        };

        async function fetchRecordedDates() {
            if (!db) return;
            const { data } = await db.from('nutrition_logs').select('record_date');
            if (data) {
                data.forEach(item => {
                    if (item.record_date) recordedDates.add(item.record_date.split('T')[0]);
                });
            }
        }

        function initCalendar() {
            calendarInstance = flatpickr("#datePickerBtn", {
                defaultDate: "today", locale: "zh", disableMobile: true,
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    const d = dayElem.dateObj;
                    const ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                    if (recordedDates.has(ds)) dayElem.classList.add('has-record');
                },
                onChange: function(selectedDates) {
                    currentDate = selectedDates[0];
                    updateHeaderDate();
                    loadData(currentDate);
                }
            });
            updateHeaderDate();
        }

        function updateHeaderDate() {
            const today = new Date();
            const isToday = currentDate.toDateString() === today.toDateString();
            document.getElementById('headerDateStr').innerText = isToday ? "ä»Šå¤©" : `${currentDate.getMonth()+1}æœˆ${currentDate.getDate()}æ—¥`;
        }

        async function loadData(date) {
            if (!db) return;
            const listEl = document.getElementById('listContainer');
            listEl.innerHTML = '<div class="empty-state"><div class="loading-spinner"></div></div>';
            const start = new Date(date); start.setHours(0,0,0,0);
            const end = new Date(date); end.setHours(23,59,59,999);

            try {
                const { data, error } = await db.from('nutrition_logs').select('*')
                    .gte('record_date', start.toISOString()).lte('record_date', end.toISOString())
                    .order('record_date', { ascending: false });
                if (error) throw error;
                renderList(data);
            } catch (e) {
                listEl.innerHTML = `<div class="empty-state">âŒ Error: ${e.message}</div>`;
            }
        }

        // --- å…¨çƒåŠ é€Ÿå™¨ ---
        function getProxyUrl(originalUrl) {
            if (!originalUrl) return null;
            // q=100 ä¿æŒæœ€é«˜ç”»è´¨ï¼Œoutput=webp ä¿è¯ä¼ è¾“é€Ÿåº¦
            return `https://wsrv.nl/?url=${encodeURIComponent(originalUrl)}&q=100&output=webp`;
        }

        function renderList(logs) {
            const listEl = document.getElementById('listContainer');
            const totalEl = document.getElementById('dayTotal');
            if (!logs || logs.length === 0) {
                listEl.innerHTML = `<div class="empty-state"><div style="font-size:40px;opacity:0.3;">ğŸ½ï¸</div><p>ä»Šå¤©æš‚æ— è®°å½•</p></div>`;
                totalEl.innerText = '0';
                return;
            }
            let html = ''; let totalCal = 0;
            logs.forEach(log => {
                totalCal += (log.calories || 0);
                const d = new Date(log.record_date);
                const timeStr = d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                
                // è·å–åŠ é€Ÿåçš„é«˜æ¸…é“¾æ¥
                const displayUrl = getProxyUrl(log.image_url);
                const imgContent = displayUrl 
                    // ã€å…³é”®ä¿®æ­£ã€‘ç‚¹å‡»æ—¶ï¼Œæ‰“å¼€çš„ä¹Ÿæ˜¯ displayUrl (åŠ é€Ÿé“¾æ¥)ï¼Œè€Œä¸æ˜¯ log.image_url (åŸå§‹é“¾æ¥)
                    ? `<img src="${displayUrl}" class="meal-img" onclick="window.open('${displayUrl}')" loading="lazy">` 
                    : `<div style="width:100%;height:200px;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:40px;">ğŸ¥˜</div>`;

                let metricsHtml = `
                    <div class="metric-item"><span class="m-val">${log.carbs || 0}</span><span class="m-label">ç¢³æ°´</span></div>
                    <div class="metric-item"><span class="m-val">${log.protein || 0}</span><span class="m-label">è›‹ç™½</span></div>
                    <div class="metric-item"><span class="m-val">${log.fat || 0}</span><span class="m-label">è„‚è‚ª</span></div>
                `;
                const opts = [{k:'fiber',l:'çº¤ç»´'}, {k:'sugar',l:'ç³–'}, {k:'sodium',l:'é’ '}, {k:'caffeine',l:'å’–å•¡å› '}];
                opts.forEach(m => { if(log[m.k]>0) metricsHtml += `<div class="metric-item"><span class="m-val">${log[m.k]}</span><span class="m-label">${m.l}</span></div>`; });

                html += `<div class="meal-card"><div class="meal-img-box">${imgContent}<div class="img-time-badge">${timeStr}</div></div><div class="meal-content"><div class="meal-header"><span class="meal-name">${log.food_name}</span><span class="meal-cal-badge">${log.calories||0} kcal</span></div><div class="metrics-grid">${metricsHtml}</div></div></div>`;
            });
            listEl.innerHTML = html;
            totalEl.innerText = totalCal;
        }

        function processHighQualityImage(file) {
            return new Promise((resolve, reject) => {
                if (file.size < 4 * 1024 * 1024) {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_DIM = 2500; 
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > MAX_DIM) { height *= MAX_DIM / width; width = MAX_DIM; } } 
                        else { if (height > MAX_DIM) { width *= MAX_DIM / height; height = MAX_DIM; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
                        resolve(dataUrl.split(',')[1]);
                    };
                };
            });
        }

        function getPhotoDate(file) {
            return new Promise((resolve) => {
                if (typeof EXIF === 'undefined') { resolve(null); return; }
                EXIF.getData(file, function() {
                    const t = EXIF.getTag(this, "DateTimeOriginal");
                    if (t) {
                        const p = t.split(/[: ]/);
                        resolve(`${p[0]}-${p[1]}-${p[2]}T${p[3]}:${p[4]}:${p[5]}+08:00`);
                    } else {
                        const d = new Date();
                        resolve(d.toISOString());
                    }
                });
            });
        }

        function safeTrigger(type) {
            if (!db) { alert("æ•°æ®åº“è¿æ¥ä¸­..."); return; }
            const input = document.getElementById('fileInput');
            if (type === 'camera') input.setAttribute('capture', 'camera');
            else input.removeAttribute('capture');
            input.click();
        }

        document.getElementById('fileInput').onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('upload-mask').style.display = 'flex';

            try {
                const base64 = await processHighQualityImage(file);
                let recordDate = await getPhotoDate(file); 
                if (!recordDate) recordDate = new Date().toISOString();

                const res = await fetch(CONFIG.funcUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': CONFIG.key, 'Authorization': 'Bearer ' + CONFIG.key },
                    body: JSON.stringify({ imageBase64: base64, record_date: recordDate })
                });

                const json = await res.json();
                if (json.success) {
                    recordedDates.add(recordDate.split('T')[0]);
                    if (calendarInstance) calendarInstance.redraw();
                    setTimeout(() => { loadData(currentDate); alert(`âœ… è®°å½•æˆåŠŸï¼`); }, 500);
                } else {
                    alert('âŒ è¯†åˆ«å¤±è´¥: ' + json.error);
                }
            } catch (err) {
                alert('âŒ é”™è¯¯: ' + err.message);
            } finally {
                document.getElementById('upload-mask').style.display = 'none';
                this.value = '';
            }
        };
    </script>
</body>
</html>