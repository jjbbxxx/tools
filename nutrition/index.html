<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI é¥®é£Ÿç®¡å®¶</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <script src="https://lib.baomitu.com/exif-js/2.3.0/exif.min.js"></script>
    <link rel="stylesheet" href="https://lib.baomitu.com/flatpickr/4.6.13/flatpickr.min.css">
    <script src="https://lib.baomitu.com/flatpickr/4.6.13/flatpickr.min.js"></script>
    <script>
    // æ‰‹åŠ¨æ³¨å†Œä¸­æ–‡è¯­è¨€åŒ…ï¼Œå½»åº•è§£å†³ CDN æŠ¥é”™é—®é¢˜
    (function (global, factory) {
        typeof exports === 'object' && typeof module !== 'undefined' ? factory(global.flatpickr) :
        typeof define === 'function' && define.amd ? define(['flatpickr'], factory) :
        (factory(global.flatpickr));
    }(this, (function (flatpickr) { 'use strict';
        var fp = flatpickr.l10ns;
        var zh = {
            weekdays: {
                shorthand: ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"],
                longhand: ["æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"]
            },
            months: {
                shorthand: ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"],
                longhand: ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"]
            },
            rangeSeparator: " è‡³ ",
            weekAbbreviation: "å‘¨",
            scrollTitle: "æ»šåŠ¨åˆ‡æ¢",
            toggleTitle: "ç‚¹å‡»åˆ‡æ¢ 12/24 å°æ—¶æ—¶åˆ¶"
        };
        fp.zh = zh;
        fp.default.l10n = zh; // è®¾ç½®ä¸ºé»˜è®¤
    })));
</script>

    <style>
        /* UI æ ·å¼ (ä¿æŒä½ å–œæ¬¢çš„æ ·å­) */
        :root { --primary: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF; --text-main: #000000; --text-sub: #8E8E93; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: var(--text-main); }
        .header { position: sticky; top: 0; background: rgba(242, 242, 247, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 16px 20px; z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .header-title small { font-size: 14px; font-weight: 400; color: var(--primary); background: rgba(0,122,255,0.1); padding: 4px 10px; border-radius: 12px; }
        .total-badge { text-align: right; }
        .total-val { font-size: 18px; font-weight: 700; color: var(--primary); }
        .total-label { font-size: 11px; color: var(--text-sub); }
        .container { padding: 16px; max-width: 600px; margin: 0 auto; }
        .meal-card { background: var(--card-bg); border-radius: 18px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); display: flex; gap: 16px; align-items: flex-start; transition: transform 0.1s; position: relative; overflow: hidden; }
        .meal-card:active { transform: scale(0.98); background: #f9f9f9; }
        .meal-img { width: 80px; height: 80px; border-radius: 14px; object-fit: cover; background: #f0f0f0; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.05); }
        .meal-content { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; height: 80px; }
        .meal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .meal-cal { font-size: 16px; font-weight: 700; color: var(--primary); }
        .meal-name { font-size: 17px; font-weight: 600; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .meal-tags { display: flex; gap: 8px; font-size: 12px; color: var(--text-sub); }
        .tag { background: #F2F2F7; padding: 2px 6px; border-radius: 6px; }
        .fab-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; gap: 16px; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); padding: 10px 16px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid rgba(0,0,0,0.05); }
        .fab-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 60px; height: 60px; border-radius: 20px; border: none; cursor: pointer; transition: all 0.2s; }
        .fab-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(0,122,255,0.4); }
        .fab-primary:active { transform: scale(0.92); }
        .fab-secondary { background: #E5E5EA; color: var(--text-main); }
        .fab-secondary:active { background: #d1d1d6; }
        .fab-icon { font-size: 24px; margin-bottom: 2px; }
        .fab-label { font-size: 10px; font-weight: 600; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-sub); }
        .loading-spinner { width: 20px; height: 20px; border: 2px solid #e1e1e1; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #upload-mask { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .big-spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s infinite; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-title" id="datePickerBtn">
            <span id="headerDateStr">ä»Šå¤©</span>
            <small>â–¼</small>
        </div>
        <div class="total-badge">
            <div class="total-val" id="dayTotal">0</div>
            <div class="total-label">ä»Šæ—¥æ‘„å…¥ (kcal)</div>
        </div>
    </div>

    <div class="container" id="listContainer">
        <div class="empty-state">
            <div class="loading-spinner"></div>
            <p style="margin-top:10px; font-size:14px;">æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®...</p>
        </div>
    </div>

    <div class="fab-bar">
        <button class="fab-btn fab-secondary" onclick="safeTrigger('album')">
            <span class="fab-icon">ğŸ–¼ï¸</span>
            <span class="fab-label">ç›¸å†Œ</span>
        </button>
        <button class="fab-btn fab-primary" onclick="safeTrigger('camera')">
            <span class="fab-icon">ğŸ“¸</span>
            <span class="fab-label">æ‹ç…§</span>
        </button>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display:none">

    <div id="upload-mask">
        <div class="big-spinner"></div>
        <h3 style="margin: 20px 0 8px 0; color: #333;">AI æ­£åœ¨åˆ†æ...</h3>
        <p style="color: #666; font-size: 14px;">è¯†åˆ«é£Ÿæ Â· ä¼°ç®—çƒ­é‡ Â· ç”Ÿæˆè®°å½•</p>
    </div>

    <script>
        const CONFIG = {
            url: 'https://kliydumuddzylhmnnmyt.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsaXlkdW11ZGR6eWxobW5ubXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTE5MzAsImV4cCI6MjA4MzE2NzkzMH0.jpO3hYrQ-UCfo3AiZKt3b8F9EBpWrybvbqjY9P-6FV4',
            funcUrl: 'https://kliydumuddzylhmnnmyt.supabase.co/functions/v1/nutrition'
        };

        // ã€ä¿®æ”¹ã€‘æ”¹åå« dbï¼Œé¿å…å’Œ window.supabase å†²çª
        let db = null;
        let currentDate = new Date();
        
        window.onload = function() {
            // 1. åˆå§‹åŒ– Supabase
            // åªè¦ä¸Šé¢çš„ script æ ‡ç­¾åŠ è½½æˆåŠŸï¼Œwindow.supabase å°±ä¸€å®šå­˜åœ¨
            if (window.supabase && window.supabase.createClient) {
                db = window.supabase.createClient(CONFIG.url, CONFIG.key);
                console.log("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ");
                initCalendar();
                loadData(currentDate);
            } else {
                document.getElementById('listContainer').innerHTML = `
                    <div class="empty-state" style="color: red;">
                        âš ï¸ ç½‘ç»œé”™è¯¯ï¼šæ ¸å¿ƒåº“åŠ è½½å¤±è´¥<br>è¯·æ£€æŸ¥ VPN æˆ–åˆ·æ–°é¡µé¢
                    </div>`;
            }
        };

        function initCalendar() {
            // æ£€æŸ¥æ—¥å†åº“æ˜¯å¦åäº†
            if (typeof flatpickr === 'undefined') {
                console.warn("æ—¥å†ç»„ä»¶åŠ è½½å¤±è´¥");
                return;
            }
            flatpickr("#datePickerBtn", {
                defaultDate: "today",
                locale: "zh",
                disableMobile: true,
                onChange: function(selectedDates) {
                    currentDate = selectedDates[0];
                    updateHeaderDate();
                    loadData(currentDate);
                }
            });
            updateHeaderDate();
        }

        function updateHeaderDate() {
            const today = new Date();
            const isToday = currentDate.toDateString() === today.toDateString();
            const str = isToday ? "ä»Šå¤©" : `${currentDate.getMonth() + 1}æœˆ${currentDate.getDate()}æ—¥`;
            document.getElementById('headerDateStr').innerText = str;
        }

        async function loadData(date) {
            if (!db) return;

            const listEl = document.getElementById('listContainer');
            listEl.innerHTML = '<div class="empty-state"><div class="loading-spinner"></div></div>';

            const start = new Date(date); start.setHours(0,0,0,0);
            const end = new Date(date); end.setHours(23,59,59,999);

            try {
                const { data, error } = await db
                    .from('nutrition_logs')
                    .select('*')
                    .gte('record_date', start.toISOString())
                    .lte('record_date', end.toISOString())
                    .order('record_date', { ascending: false });

                if (error) throw error;
                renderList(data);
            } catch (e) {
                listEl.innerHTML = `<div class="empty-state">âŒ å†å²è®°å½•è·å–å¤±è´¥: ${e.message}</div>`;
            }
        }

        function renderList(logs) {
            const listEl = document.getElementById('listContainer');
            const totalEl = document.getElementById('dayTotal');
            
            if (!logs || logs.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size:40px;margin-bottom:10px;">ğŸ½ï¸</div>
                        ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•<br>ç‚¹å‡»åº•éƒ¨æŒ‰é’®å¼€å§‹è®°å½•å§
                    </div>`;
                totalEl.innerText = '0';
                return;
            }

            let html = '';
            let totalCal = 0;

            logs.forEach(log => {
                totalCal += (log.calories || 0);
                const d = new Date(log.record_date);
                const timeStr = d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                const imgUrl = log.image_url || null;
                const imgTag = imgUrl 
                    ? `<img src="${imgUrl}" class="meal-img" onclick="window.open('${imgUrl}')">` 
                    : `<div class="meal-img" style="display:flex;align-items:center;justify-content:center;font-size:24px;background:#f2f2f7;">ğŸ¥˜</div>`;

                html += `
                    <div class="meal-card">
                        ${imgTag}
                        <div class="meal-content">
                            <div class="meal-header">
                                <span class="meal-name">${log.food_name}</span>
                                <span class="meal-cal">${log.calories || 0}</span>
                            </div>
                            <div class="meal-tags">
                                <span class="tag">ç¢³æ°´ ${log.carbs||0}</span>
                                <span class="tag">è›‹ç™¾ ${log.protein||0}</span>
                                <span class="tag">è„‚è‚ª ${log.fat||0}</span>
                            </div>
                            <div style="margin-top:6px; font-size:12px; color:#aaa;">${timeStr}</div>
                        </div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
            animateValue(totalEl, parseInt(totalEl.innerText), totalCal, 500);
        }

        function safeTrigger(type) {
            if (!db) { alert("âš ï¸ æ•°æ®åº“è¿æ¥ä¸­ï¼Œè¯·ç¨å€™..."); return; }
            const input = document.getElementById('fileInput');
            if (type === 'camera') input.setAttribute('capture', 'camera');
            else input.removeAttribute('capture');
            input.click();
        }

        document.getElementById('fileInput').onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('upload-mask').style.display = 'flex';

            try {
                const base64 = await getBase64(file);
                let recordDate = await getPhotoDate(file); 
                if (!recordDate) recordDate = new Date().toISOString();

                const res = await fetch(CONFIG.funcUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': CONFIG.key,
                        'Authorization': 'Bearer ' + CONFIG.key
                    },
                    body: JSON.stringify({
                        imageBase64: base64,
                        record_date: recordDate
                    })
                });

                const json = await res.json();
                
                if (json.success) {
                    setTimeout(() => {
                        loadData(currentDate);
                        alert(`âœ… è®°å½•æˆåŠŸï¼\nçƒ­é‡: ${json.data.calories} kcal`);
                    }, 500);
                } else {
                    alert('âŒ è¯†åˆ«å¤±è´¥: ' + json.error);
                }

            } catch (err) {
                alert('âŒ ç½‘ç»œæˆ–ç³»ç»Ÿé”™è¯¯: ' + err.message);
            } finally {
                document.getElementById('upload-mask').style.display = 'none';
                this.value = '';
            }
        };

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
            });
        }

        function getPhotoDate(file) {
            return new Promise((resolve) => {
                if (typeof EXIF === 'undefined') { resolve(null); return; }
                EXIF.getData(file, function() {
                    const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                    if (exifDate) {
                        const p = exifDate.split(/[: ]/);
                        resolve(`${p[0]}-${p[1]}-${p[2]}T${p[3]}:${p[4]}:${p[5]}+08:00`);
                    } else {
                        const d = new Date(file.lastModified);
                        const pad = n => n.toString().padStart(2, '0');
                        const offset = 8 * 60; 
                        const local = d.getTimezoneOffset();
                        const target = new Date(d.getTime() + (offset + local) * 60000);
                        resolve(`${target.getFullYear()}-${pad(target.getMonth()+1)}-${pad(target.getDate())}T${pad(target.getHours())}:${pad(target.getMinutes())}:${pad(target.getSeconds())}+08:00`);
                    }
                });
            });
        }
    </script>
</body>
</html>