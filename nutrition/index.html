<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¯æ—¥è¥å…»è®°å½•</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --bg: #F2F2F7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 400px; }
        .card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05); margin-bottom: 20px; text-align: center; }
        h1 { font-size: 22px; font-weight: 700; margin: 0 0 20px 0; color: #1C1C1E; }
        #preview { width: 100%; border-radius: 12px; margin-bottom: 20px; display: none; object-fit: cover; max-height: 300px; }
        .btn-group { display: flex; gap: 10px; flex-direction: column; }
        .btn { border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
        .btn-outline { background: #E5E5EA; color: #3A3A3C; }
        #loading { display: none; margin: 20px 0; color: var(--primary); font-weight: 500; }
        .result-card { background: #F9F9FB; border-radius: 15px; padding: 16px; margin-top: 20px; text-align: left; display: none; }
        .result-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #EDEDF0; }
        .result-row:last-child { border: none; }
        .label { color: #8E8E93; }
        .value { font-weight: 600; color: #1C1C1E; }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ AI é¥®é£Ÿç®¡å®¶</h1>
            <img id="preview">
            <input type="file" id="fileInput" accept="image/*" style="display: none;">

            <div class="btn-group">
                <button class="btn btn-outline" onclick="triggerInput('camera')">ğŸ“¸ æ‹ç…§å½•å…¥</button>
                <button class="btn btn-outline" onclick="triggerInput('album')">ğŸ–¼ï¸ ä»ç›¸å†Œé€‰æ‹©</button>
                <button class="btn btn-primary" id="uploadBtn" style="display: none;" onclick="upload()">å¼€å§‹ AI æ™ºèƒ½è¯†åˆ«</button>
            </div>

            <div id="loading">âœ¨ AI æ­£åœ¨åŠªåŠ›åˆ†æä¸­...</div>

            <div id="result" class="result-card">
                <div style="font-weight: bold; font-size: 18px; margin-bottom: 12px;" id="foodName"></div>
                
                <div class="result-row" id="row_cal"><span class="label">Dietary Energy</span><span class="value" id="res_cal"></span></div>
                <div class="result-row" id="row_pro"><span class="label">Protein</span><span class="value" id="res_pro"></span></div>
                <div class="result-row" id="row_car"><span class="label">Carbohydrates</span><span class="value" id="res_car"></span></div>
                <div class="result-row" id="row_fat"><span class="label">Total Fat</span><span class="value" id="res_fat"></span></div>
                <div class="result-row" id="row_fib"><span class="label">Fiber</span><span class="value" id="res_fib"></span></div>
                
                <div class="result-row" id="row_sug" style="display:none"><span class="label">Dietary Sugar</span><span class="value" id="res_sug"></span></div>
                <div class="result-row" id="row_sat" style="display:none"><span class="label">Saturated Fat</span><span class="value" id="res_sat"></span></div>
                <div class="result-row" id="row_sod" style="display:none"><span class="label">Sodium</span><span class="value" id="res_sod"></span></div>
                <div class="result-row" id="row_caf" style="display:none"><span class="label">Caffeine</span><span class="value" id="res_caf"></span></div>
                <div class="result-row" id="row_wat" style="display:none"><span class="label">Water</span><span class="value" id="res_wat"></span></div>

                <div style="font-size: 12px; color: #AEAEB2; margin-top: 10px;" id="res_date"></div>
                <div style="font-size: 12px; color: #007AFF; margin-top: 4px;" id="res_loc"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        const fileInput = document.getElementById('fileInput');

        function triggerInput(mode) {
            if (mode === 'camera') fileInput.setAttribute('capture', 'camera');
            else fileInput.removeAttribute('capture');
            fileInput.click();
        }

        fileInput.onchange = e => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = event => {
                    document.getElementById('preview').src = event.target.result;
                    document.getElementById('preview').style.display = 'block';
                    document.getElementById('uploadBtn').style.display = 'block';
                    document.getElementById('result').style.display = 'none';
                };
                reader.readAsDataURL(selectedFile);
            }
        };

        // ã€ä¿®å¤ã€‘æ›´å¼ºå£®çš„è½¬æ¢å‡½æ•°
        function convertDMSToDD(degrees, minutes, seconds, direction) {
            // 1. å®‰å…¨å–å€¼ï¼šè½¬ä¸ºæµ®ç‚¹æ•°ï¼Œå¦‚æœæ˜¯ NaN åˆ™å˜æˆ 0
            const d = parseFloat(degrees) || 0;
            const m = parseFloat(minutes) || 0;
            const s = parseFloat(seconds) || 0;
            
            // 2. æ ¸å¿ƒå…¬å¼
            let dd = d + (m / 60) + (s / 3600);
            
            // 3. å¤„ç†æ–¹å‘ (S=å—çº¬, W=è¥¿ç» ä¸ºè´Ÿæ•°)
            // æœ‰äº›æ‰‹æœºå¯èƒ½ä¸å­˜ Refï¼Œå¦‚æœ Ref æ˜¯ undefinedï¼Œé»˜è®¤å½“åšæ­£æ•°å¤„ç†
            if (direction && (direction === "S" || direction === "W")) {
                dd = dd * -1;
            }
            return dd;
        }

        // ã€ä¿®å¤ã€‘è·å–å…ƒæ•°æ®
        function getPhotoMeta(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    const meta = { date: null, lat: null, lon: null };

                    // --- è°ƒè¯•æ—¥å¿—ï¼šçœ‹çœ‹åŸå§‹æ•°æ®åˆ°åº•é•¿å•¥æ · ---
                    const latRaw = EXIF.getTag(this, "GPSLatitude");
                    const lonRaw = EXIF.getTag(this, "GPSLongitude");
                    console.log("åŸå§‹çº¬åº¦æ•°æ®:", latRaw);
                    console.log("åŸå§‹ç»åº¦æ•°æ®:", lonRaw);
                    // -------------------------------------

                    // 1. è§£æ GPS (å¢åŠ ç©ºå€¼æ£€æŸ¥)
                    const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                    const lonRef = EXIF.getTag(this, "GPSLongitudeRef");

                    // åªè¦æ‹¿åˆ°æ•°ç»„ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ•°ï¼Œæˆ‘ä»¬å°±å°è¯•è½¬æ¢
                    if (latRaw && latRaw.length >= 2 && lonRaw && lonRaw.length >= 2) {
                        meta.lat = convertDMSToDD(latRaw[0], latRaw[1], latRaw[2], latRef);
                        meta.lon = convertDMSToDD(lonRaw[0], lonRaw[1], lonRaw[2], lonRef);
                        
                        // å†æ¬¡æ£€æŸ¥ç»“æœæ˜¯å¦ä¸º NaN
                        if (isNaN(meta.lat) || isNaN(meta.lon)) {
                            console.error("è®¡ç®—ç»“æœä¸º NaNï¼ŒåŸå§‹æ•°æ®æ ¼å¼å¯èƒ½å¼‚å¸¸");
                            alert("âš ï¸ è·å–åˆ° GPS æ•°æ®ï¼Œä½†æ ¼å¼æ— æ³•è§£æ (NaN)ã€‚è¯·çœ‹æ§åˆ¶å°æ—¥å¿—ã€‚");
                            meta.lat = null;
                            meta.lon = null;
                        } else {
                            console.log(`âœ… åæ ‡è§£ææˆåŠŸ: ${meta.lat}, ${meta.lon}`);
                        }
                    } else {
                        console.log("æ— å®Œæ•´ GPS æ•°æ®");
                    }

                    // 2. è§£ææ—¶é—´ (é€»è¾‘ä¸å˜)
                    let exifDate = EXIF.getTag(this, "DateTimeOriginal");
                    if (exifDate) {
                        let p = exifDate.split(/[: ]/);
                        meta.date = `${p[0]}-${p[1]}-${p[2]}T${p[3]}:${p[4]}:${p[5]}+08:00`;
                    } else {
                        const d = new Date(file.lastModified);
                        const pad = n => n.toString().padStart(2, '0');
                        // å¼ºåˆ¶åŒ—äº¬æ—¶é—´ +08:00
                        const offset = 8 * 60; // åˆ†é’Ÿ
                        const localOffset = d.getTimezoneOffset(); // åˆ†é’Ÿ
                        const targetTime = d.getTime() + (offset + localOffset) * 60000;
                        const bDate = new Date(targetTime);
                        
                        meta.date = `${bDate.getFullYear()}-${pad(bDate.getMonth()+1)}-${pad(bDate.getDate())}T${pad(bDate.getHours())}:${pad(bDate.getMinutes())}:${pad(bDate.getSeconds())}+08:00`;
                    }

                    resolve(meta);
                });
            });
        }

        async function upload() {
            if (!selectedFile) return;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('uploadBtn').disabled = true;

            try {
                const meta = await getPhotoMeta(selectedFile);
                
                const reader = new FileReader();
                reader.readAsDataURL(selectedFile);
                reader.onload = async () => {
                    const base64Data = reader.result.split(',')[1];
                    
                    const response = await fetch('https://kliydumuddzylhmnnmyt.supabase.co/functions/v1/nutrition', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsaXlkdW11ZGR6eWxobW5ubXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTE5MzAsImV4cCI6MjA4MzE2NzkzMH0.jpO3hYrQ-UCfo3AiZKt3b8F9EBpWrybvbqjY9P-6FV4',
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsaXlkdW11ZGR6eWxobW5ubXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTE5MzAsImV4cCI6MjA4MzE2NzkzMH0.jpO3hYrQ-UCfo3AiZKt3b8F9EBpWrybvbqjY9P-6FV4'
                        },
                        body: JSON.stringify({
                            imageBase64: base64Data,
                            record_date: meta.date,
                            lat: meta.lat,
                            lon: meta.lon
                        })
                    });

                    const res = await response.json();
                    if (res.success) showResult(res.data, meta);
                    else alert('è¯†åˆ«å¤±è´¥: ' + res.error);
                };
            } catch (e) {
                console.error(e);
                alert('ç½‘ç»œé”™è¯¯');
            } finally {
               // loading logic
            }
        }

        function updateRow(rowId, valId, value, unit) {
            const row = document.getElementById(rowId);
            const valSpan = document.getElementById(valId);
            if (value !== undefined && value !== null && value !== 0) {
                row.style.display = 'flex';
                valSpan.innerText = value + ' ' + unit;
            } else {
                row.style.display = 'none';
            }
        }

        function showResult(data, meta) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('uploadBtn').disabled = false;
            
            document.getElementById('result').style.display = 'block';
            document.getElementById('foodName').innerText = data.food_name;
            
            const displayDate = new Date(meta.date);
            document.getElementById('res_date').innerText = 'æ—¶é—´: ' + displayDate.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
            
            // ä¼˜å…ˆæ˜¾ç¤ºåç«¯æŸ¥åˆ°çš„ä¸­æ–‡åœ°å
            if (data.location_name) {
                document.getElementById('res_loc').innerText = `ğŸ“ åœ°ç‚¹: ${data.location_name}`;
            } else if (meta.lat) {
                document.getElementById('res_loc').innerText = `ğŸ“ åæ ‡: ${meta.lat.toFixed(4)}, ${meta.lon.toFixed(4)}`;
            } else {
                document.getElementById('res_loc').innerText = "";
            }

            updateRow('row_cal', 'res_cal', data.calories, 'kcal');
            updateRow('row_pro', 'res_pro', data.protein, 'g');
            updateRow('row_car', 'res_car', data.carbs, 'g');
            updateRow('row_fat', 'res_fat', data.fat, 'g');
            updateRow('row_fib', 'res_fib', data.fiber, 'g');
            updateRow('row_sug', 'res_sug', data.sugar, 'g');
            updateRow('row_sat', 'res_sat', data.saturated_fat, 'g');
            updateRow('row_sod', 'res_sod', data.sodium, 'g');
            updateRow('row_caf', 'res_caf', data.caffeine, 'g');
            updateRow('row_wat', 'res_wat', data.water, 'g');
        }
    </script>

</body>
</html>